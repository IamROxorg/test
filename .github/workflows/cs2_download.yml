name: CS2 Final Downloader (No Disk Error)
on: 
  workflow_dispatch:

jobs:
  download_cs2:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Nettoyage agressif de la racine (Partition /)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          overprovision-lvm: 'true' # Utilise les 93 Go de ta partition LVM

      - name: 2. Setup .NET 8 (Requis pour v3.4.0)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: 3. Installation DepotDownloader
        run: |
          wget https://github.com/SteamRE/DepotDownloader/releases/download/DepotDownloader_3.4.0/DepotDownloader-linux-x64.zip
          unzip DepotDownloader-linux-x64.zip
          chmod +x DepotDownloader

      - name: 4. Téléchargement CS2 (App 730)
        # On télécharge les 33.5 Go sur la partition LVM de 93 Go
        run: |
          ./DepotDownloader -app 730 -user ${{ secrets.STEAM_USER }} -pass ${{ secrets.STEAM_PASS }} -dir ${{ github.workspace }}/CS2_Data -validate

      - name: 5. Compression et Upload Direct (Streaming)
        # On ne crée PAS de fichier .tar sur le disque pour éviter de le remplir.
        # Les données passent directement de 'tar' vers 'transfer.sh' via le tunnel '|'.
        run: |
          tar -cv -C ${{ github.workspace }}/CS2_Data . | curl --upload-file - https://transfer.sh/cs2_full_game.tar
