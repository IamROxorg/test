name: CS2 SPLIT UPLOAD (SAFE MODE)
on: workflow_dispatch

jobs:
  download_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Nettoyage et Maximisation (96 Go)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          overprovision-lvm: 'true'

      - name: 2. Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: 3. Installation DepotDownloader
        run: |
          wget https://github.com/SteamRE/DepotDownloader/releases/download/DepotDownloader_3.4.0/DepotDownloader-linux-x64.zip
          unzip DepotDownloader-linux-x64.zip
          chmod +x DepotDownloader

      - name: 4. Téléchargement CS2 (Main + Binaries ensemble)
        # On télécharge tout d'un coup, on a la place (96Go > 35Go)
        run: |
          ./DepotDownloader -app 730 -depot 2347770 -user ${{ secrets.STEAM_USER }} -pass ${{ secrets.STEAM_PASS }} -dir ./CS2_Full -validate
          ./DepotDownloader -app 730 -depot 2347771 -user ${{ secrets.STEAM_USER }} -pass ${{ secrets.STEAM_PASS }} -dir ./CS2_Full -validate

      - name: 5. Compression, Découpage et Upload (Boucle)
        # C'est la magie : On tar, on pipe vers split qui crée des fichiers de 2Go
        # Ensuite on boucle pour uploader chaque morceau
        run: |
          echo "Création des archives découpées (2Go chacune)..."
          # On crée des fichiers cs2_part_aa, cs2_part_ab, etc.
          tar -c -C ./CS2_Full . | split -b 2000M - cs2_part_

          echo "Suppression des fichiers sources pour faire de la place..."
          rm -rf ./CS2_Full

          echo "Début de l'upload séquentiel des parties..."
          
          # On boucle sur chaque fichier créé par split
          for file in cs2_part_*; do
            echo "---------------------------------------------------"
            echo "Upload de $file ..."
            # On envoie le fichier
            RESPONSE=$(curl -X POST https://api.gofile.io/uploadFile -F "file=@$file")
            
            # On affiche le lien clairement
            echo "RÉPONSE GOFILE POUR $file :"
            echo "$RESPONSE"
            
            # On supprime le fichier uploadé pour libérer l'espace disque
            rm -f "$file"
          done
          
