name: CS2 FINAL REPAIR
on: workflow_dispatch

jobs:
  download_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Nettoyage Système
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc "/usr/local/share/boost"
          sudo apt-get autoremove -y && sudo apt-get clean

      - name: 2. Maximiser l'espace (96 Go)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          overprovision-lvm: 'true'

      - name: 3. Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: 4. Installation DepotDownloader
        run: |
          wget https://github.com/SteamRE/DepotDownloader/releases/download/DepotDownloader_3.4.0/DepotDownloader-linux-x64.zip
          unzip DepotDownloader-linux-x64.zip
          chmod +x DepotDownloader

      - name: 5. Téléchargement CS2 (Dépôt Principal)
        run: |
          ./DepotDownloader -app 730 -depot 2347770 -user ${{ secrets.STEAM_USER }} -pass ${{ secrets.STEAM_PASS }} -dir ./CS2_Main -validate

      - name: 6. Upload GoFile (Méthode Anti-Redirect)
        run: |
          # 1. On cherche le serveur avec 5 essais (pour éviter l'erreur jq)
          SERVER=""
          for i in {1..5}; do
            echo "Tentative $i pour trouver un serveur GoFile..."
            JSON=$(curl -s -f https://api.gofile.io/getServer || echo "")
            SERVER=$(echo "$JSON" | jq -r '.data.server // empty')
            
            if [[ -n "$SERVER" && "$SERVER" != "null" ]]; then
              echo "Serveur trouvé : $SERVER"
              break
            fi
            sleep 3
          done

          if [[ -z "$SERVER" ]]; then
            echo "ERREUR CRITIQUE: Impossible de contacter l'API GoFile après 5 essais."
            exit 1
          fi

          # 2. On lance l'upload sur ce serveur PRÉCIS (Pas de redirection = Pas de crash du Pipe)
          # On remet le filename car sans redirection, curl le gère très bien
          echo "Démarrage du stream vers $SERVER..."
          tar -cv --remove-files -C ./CS2_Main . | curl -X POST -F "file=@-;filename=cs2_main.tar" "https://$SERVER.gofile.io/uploadFile"

      - name: 7. Téléchargement Binaires
        run: |
          ./DepotDownloader -app 730 -depot 2347771 -user ${{ secrets.STEAM_USER }} -pass ${{ secrets.STEAM_PASS }} -dir ./CS2_Bin -validate

      - name: 8. Upload Binaires (Méthode Anti-Redirect)
        run: |
          # On réutilise la même logique (le serveur peut changer)
          SERVER=$(curl -s https://api.gofile.io/getServer | jq -r '.data.server')
          tar -cv --remove-files -C ./CS2_Bin . | curl -X POST -F "file=@-;filename=cs2_bin.tar" "https://$SERVER.gofile.io/uploadFile"
